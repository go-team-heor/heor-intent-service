name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
    - name: Build and push to DO
    # You may pin to the exact commit or the version.
    # uses: ripplr-io/docr-docker-publish@44fac8d6ff7c3ece58c9ffe50f370514d166f5b7
      run: > 
        SHA=$(echo $GITHUB_SHA | cut -c1-8)
        docker build .
        -t registry.digitalocean.com/go-team-heor/heor-intent-service:$SHA
        -t registry.digitalocean.com/go-team-heor/heor-intent-service:latest
    - name: Log into registry
      run: doctl registry login --expiry-seconds 600
    - name: Push to DO
      run: docker push -a registry.digitalocean.com/go-team-heor/heor-intent-service
      
